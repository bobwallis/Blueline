#!/bin/bash

# Get script directory, and cd to it
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ] ; do SOURCE="$(readlink "$SOURCE")"; done
d="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
cd "$d"

# Parse options
usage()
{
cat << EOF

Usage: $0 [options]
This script updates Blueline.

Options:
 --nopull  Prevents the pulling of new application code.
 --nodata  Prevents the update of association/method/tower data
 --dev     Updates a development version
 --help    Shows this message
EOF
}
source "$d/resources/scripts/getopts_long.sh"
CCCBRDATA=true
GITPULL=true
DEV=false
OPTLIND=1
while getopts_long :dpfeh opt \
	nodata no_argument \
	nopull no_argument \
	dev no_argument \
	help 0 "" "$@"
	do
		case "$opt" in
			d|nodata) CCCBRDATA=false;;
			p|nopull) GITPULL=false;;
			e|dev) DEV=true;;
			h|help) usage; exit 0;;
			:) printf >&2 '%s: %s\n' "${0##*/}" "$OPTLERR"
				usage
				exit 1;;
		esac
	done
shift "$(($OPTLIND - 1))"

# Pull latest version
if [[ $GITPULL = true && $DEV = false ]]
	then
	echo -e "\n\033[1mPulling latest version of Blueline\033[0m"
	git pull
	# Restart update script (to allow it to update itself)
	if [[ $CCCBRDATA = true ]]
	then
		"$d/update" --nopull
	else
		"$d/update" --nopull --nodata
	fi
	exit
fi

# Update composer.phar
if [[ ! ( -e "$d/composer.phar" ) ]]; then
	echo -e "\n\033[1mInstalling Composer\033[0m"
	curl -sS https://getcomposer.org/installer | php
else
	echo -e "\n\033[1mUpdating Composer\033[0m"
	php -d memory_limit=2G "$d/composer.phar" self-update
fi

# Update vendors
echo -e "\n\033[1mUpdating /vendors\033[0m"
if [[ $DEV = true ]]; then
	php -d memory_limit=2G "$d/composer.phar" update
else
	php -d memory_limit=2G "$d/composer.phar" install
	php -d memory_limit=2G "$d/composer.phar" dump-autoload --optimize
fi

# Update node_modules
echo -e "\n\033[1mUpdating /node_modules\033[0m"
if [[ $DEV = true ]]; then
	npm update --save-dev
else
	npm install
fi

# Clear cache
echo -e "\n\033[1mClearing Symfony cache\033[0m"
php "$d/bin/console" cache:clear --no-warmup --env=prod
php "$d/bin/console" cache:warm --env=prod
php "$d/bin/console" doctrine:cache:clear-metadata
php "$d/bin/console" doctrine:cache:clear-query
php "$d/bin/console" doctrine:cache:clear-result


# Verify that Doctrine is properly configured for a production environment, and mappings are up to date
echo -e "\n\033[1mChecking Doctrine configuration\033[0m"
php "$d/bin/console" doctrine:ensure-production-settings --env=prod
php "$d/bin/console" doctrine:schema:validate


# Rebuild web assets
echo -e "\n\033[1mRebuilding CSS and JS assets\033[0m"
rm -rf "$d/web/components"
rm -rf "$d/web/bundles"
rm -rf "$d/web/assetic"
rm -rf "$d/web/css"
rm -rf "$d/web/js"
rm -rf "$d/web/fonts"
gulp

if [[ $CCCBRDATA = true ]]
	then
	# Download external data
	echo -e "\n\033[1mDownloading external data\033[0m"
	"$d/src/Blueline/MethodsBundle/Resources/data/fetch"
	"$d/src/Blueline/TowersBundle/Resources/data/fetch"
	echo ""

	# Import updated association data
	php "$d/bin/console" blueline:importAssociations
	echo ""

	# Import updated tower data
	php "$d/bin/console" blueline:importTowers
	php "$d/bin/console" blueline:importOldPKs
	echo ""

	# Import updated method data
	php "$d/bin/console" blueline:importMethods
	php "$d/bin/console" blueline:importMethodExtras
	php "$d/bin/console" blueline:importCollections
	php "$d/bin/console" blueline:calculateMethodSimilarities
	echo ""
	php "$d/bin/console" blueline:linkPerformancesToDove
	sed -i -e"s/database_update: .*/database_update: `date "+%s"`/" "$d/app/config/parameters.yml"
fi

echo -e "\n\033[1mRebuilding image assets in the background\033[0m"
nohup gulp images_all &>/dev/null &

# Update source timestamp to refresh caching headers etc
sed -i -e"s/asset_update: .*/asset_update: `date "+%s"`/" "$d/app/config/parameters.yml"
